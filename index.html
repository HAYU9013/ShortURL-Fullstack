<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>短網址服務前端</title>
  <!-- 載入 Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-4">
    <!-- 導覽列：依登入狀態顯示登入/註冊或登出按鈕 -->
    <div id="nav" class="mb-4">
      <button id="login-btn" class="btn btn-primary me-2">登入</button>
      <button id="register-btn" class="btn btn-secondary me-2">註冊</button>
      <button id="logout-btn" class="btn btn-danger d-none">登出</button>
    </div>

    <!-- 登入 / 註冊表單 -->
    <div id="forms">
      <div id="login-form" class="mb-4 d-none">
        <h2>登入</h2>
        <form id="form-login">
          <div class="mb-3">
            <input type="text" id="login-username" class="form-control" placeholder="使用者名稱" required>
          </div>
          <div class="mb-3">
            <input type="password" id="login-password" class="form-control" placeholder="密碼" required>
          </div>
          <button type="submit" class="btn btn-primary">登入</button>
        </form>
      </div>
      <div id="register-form" class="mb-4 d-none">
        <h2>註冊</h2>
        <form id="form-register">
          <div class="mb-3">
            <input type="text" id="register-username" class="form-control" placeholder="使用者名稱" required>
          </div>
          <div class="mb-3">
            <input type="password" id="register-password" class="form-control" placeholder="密碼" required>
          </div>
          <button type="submit" class="btn btn-secondary">註冊</button>
        </form>
      </div>
    </div>

    <!-- 創建短網址區塊 -->
    <div id="shorten-section" class="mb-4">
      <h2>創造短網址</h2>
      <form id="form-shorten" class="mb-3">
        <div class="mb-3">
          <input type="url" id="long-url" class="form-control" placeholder="請輸入長網址" required>
        </div>
        <button type="submit" class="btn btn-success">創建短網址</button>
      </form>
      <div id="shorten-result"></div>
    </div>

    <!-- 使用者創建的短網址列表，僅在已登入時顯示 -->
    <div id="my-urls-section" class="mb-4 d-none">
      <h2>我的短網址</h2>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>長網址</th>
            <th>短網址</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="urls-table-body">
          <!-- 列表內容由 JavaScript 動態填入 -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- 載入 Bootstrap JS Bundle (包含 Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 全域變數：登入狀態
    let isLoggedIn = false;
    // 後端基底 URL
    const BASE_URL = 'http://localhost:8000';

    // 取得各 DOM 元素
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loginFormDiv = document.getElementById('login-form');
    const registerFormDiv = document.getElementById('register-form');
    const formLogin = document.getElementById('form-login');
    const formRegister = document.getElementById('form-register');
    const formShorten = document.getElementById('form-shorten');
    const shortenResultDiv = document.getElementById('shorten-result');
    const myUrlsSection = document.getElementById('my-urls-section');
    const urlsTableBody = document.getElementById('urls-table-body');

    // 按鈕點擊切換表單顯示
    loginBtn.addEventListener('click', () => {
      loginFormDiv.classList.toggle('d-none');
      registerFormDiv.classList.add('d-none');
    });
    registerBtn.addEventListener('click', () => {
      registerFormDiv.classList.toggle('d-none');
      loginFormDiv.classList.add('d-none');
    });
    logoutBtn.addEventListener('click', logout);

    // 註冊表單提交
    formRegister.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('register-username').value;
      const password = document.getElementById('register-password').value;
      try {
        const response = await fetch(`${BASE_URL}/api/users/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
          credentials: 'include'
        });
        if (response.ok) {
          alert('註冊成功，請登入');
          registerFormDiv.classList.add('d-none');
        } else {
          const data = await response.json();
          alert('註冊失敗：' + (data.message || response.statusText));
        }
      } catch (error) {
        console.error('註冊錯誤:', error);
        alert('註冊時發生錯誤');
      }
    });

    // 登入表單提交
    formLogin.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      try {
        const response = await fetch(`${BASE_URL}/api/users/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
          credentials: 'include'
        });
        if (response.ok) {
          alert('登入成功');
          isLoggedIn = true;
          updateNav();
          loginFormDiv.classList.add('d-none');
          loadMyUrls();
        } else {
          const data = await response.json();
          alert('登入失敗：' + (data.message || response.statusText));
        }
      } catch (error) {
        console.error('登入錯誤:', error);
        alert('登入時發生錯誤');
      }
    });

    // 登出操作
    async function logout() {
      try {
        const response = await fetch(`${BASE_URL}/api/users/logout`, {
          method: 'POST',
          credentials: 'include'
        });
        if (response.ok) {
          alert('登出成功');
          isLoggedIn = false;
          updateNav();
          myUrlsSection.classList.add('d-none');
        } else {
          alert('登出失敗');
        }
      } catch (error) {
        console.error('登出錯誤:', error);
        alert('登出時發生錯誤');
      }
    }

    // 更新導覽列與頁面顯示
    function updateNav() {
      if (isLoggedIn) {
        loginBtn.classList.add('d-none');
        registerBtn.classList.add('d-none');
        logoutBtn.classList.remove('d-none');
        myUrlsSection.classList.remove('d-none');
      } else {
        loginBtn.classList.remove('d-none');
        registerBtn.classList.remove('d-none');
        logoutBtn.classList.add('d-none');
        myUrlsSection.classList.add('d-none');
      }
    }

    // 創建短網址表單提交
    formShorten.addEventListener('submit', async (e) => {
      e.preventDefault();
      const longUrl = document.getElementById('long-url').value;
      // 根據是否登入選擇不同 API endpoint
      let endpoint = isLoggedIn ? '/u/shorten' : '/shorten';
      try {
        const token = document.cookie.split('=')[1]; // 假設 token 存在 cookie 中
        const response = await fetch(`${BASE_URL}/api/url${endpoint}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ long_url: longUrl }),
          credentials: 'include'
        });
        const data = await response.json();
        if (response.ok) {
          shortenResultDiv.innerText = '短網址：' + data.short_url;
          if (isLoggedIn) loadMyUrls();
        } else {
          alert('創建短網址失敗：' + (data.message || response.statusText));
        }
      } catch (error) {
        console.error('短網址創建錯誤:', error);
        alert('創建短網址時發生錯誤');
      }
    });

    // 載入使用者創建的短網址列表
    async function loadMyUrls() {
      try {
        const response = await fetch(`${BASE_URL}/api/url/my-urls`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });
        const data = await response.json();
        console.log('Fetched data:', data);
        if (response.ok) {
          urlsTableBody.innerHTML = '';
          data.forEach(item => {
            const tr = document.createElement('tr');
            const tdLong = document.createElement('td');
            tdLong.innerText = item.long_url;
            const tdShort = document.createElement('td');
            tdShort.innerText = item.short_url;
            const tdAction = document.createElement('td');
            const delBtn = document.createElement('button');
            delBtn.innerText = '刪除';
            delBtn.className = 'btn btn-danger btn-sm';
            delBtn.addEventListener('click', () => {
              deleteUrl(item.id);
            });
            tdAction.appendChild(delBtn);
            tr.appendChild(tdLong);
            tr.appendChild(tdShort);
            tr.appendChild(tdAction);
            urlsTableBody.appendChild(tr);
          });
        } else {
          alert('取得短網址列表失敗：' + (data.message || response.statusText));
        }
      } catch (error) {
        console.error('載入短網址列表錯誤:', error);
        alert('取得短網址列表時發生錯誤');
      }
    }

    // 刪除短網址
    async function deleteUrl(shortUrlId) {
      if (!confirm('確定刪除此短網址？')) return;
      try {
        const response = await fetch(`${BASE_URL}/api/url/d/${shortUrlId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (response.ok) {
          alert('刪除成功');
          loadMyUrls();
        } else {
          const data = await response.json();
          alert('刪除失敗：' + (data.message || response.statusText));
        }
      } catch (error) {
        console.error('刪除錯誤:', error);
        alert('刪除短網址時發生錯誤');
      }
    }

    // 初始化介面
    updateNav();
  </script>
</body>
</html>
